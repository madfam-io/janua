# Nixpacks configuration for FastAPI deployment
[phases.setup]
nixPkgs = [
  "python311",
  "postgresql15",
  "gcc",
  # SAML/XML processing dependencies with dev headers
  "libxml2",
  "libxml2.dev",
  "libxmlsec1",
  "libxmlsec1.dev", 
  "libxslt",
  "libxslt.dev",
  "pkgconfig",
  "openssl",
  "openssl.dev"
]

[phases.install]
cmds = [
  "pip install --upgrade pip",
  # Set environment variables for XML library compilation
  "export PKG_CONFIG_PATH=/nix/store/*/lib/pkgconfig:/nix/store/*/share/pkgconfig",
  "export CFLAGS=\"-I/nix/store/*/include/libxml2 -I/nix/store/*/include/xmlsec1\"",
  "export LDFLAGS=\"-L/nix/store/*/lib\"",
  "pip install -r requirements.txt"
]

[phases.build]
# No build step needed for Python API

[start]
cmd = "uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000}"