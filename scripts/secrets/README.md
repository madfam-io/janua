# Janua Secrets Management

Scripts for managing Janua secrets in Kubernetes.

## Requirements

- `kubectl` or SSH access to K8s cluster via `ssh.madfam.io`
- `openssl` for generating secrets
- `jq` (optional, only needed for export/import commands)

## Quick Start

```bash
# List current secrets
./manage-secrets.sh list --remote

# Verify all required secrets exist
./manage-secrets.sh verify --remote

# Generate new secret values (for rotation)
./manage-secrets.sh generate

# Rotate a specific secret
./manage-secrets.sh rotate jwt-secret --remote
```

## Commands

| Command | Description |
|---------|-------------|
| `list` | List all secrets in the K8s namespace |
| `export` | Export secrets to local encrypted file |
| `import` | Import secrets from file to K8s |
| `generate` | Generate new random secret values |
| `rotate` | Rotate a specific secret key |
| `verify` | Verify all required secrets are present |
| `template` | Print .env template file |

## Remote Operations

Use `--remote` flag to execute against the production K8s cluster via SSH tunnel:

```bash
./manage-secrets.sh list --remote
./manage-secrets.sh verify --remote
```

This uses `ssh.madfam.io` (Cloudflare Tunnel) to connect to the server.

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `NAMESPACE` | janua | K8s namespace |
| `SECRET_NAME` | janua-secrets | K8s secret name |
| `SECRETS_DIR` | ~/.janua-secrets | Local directory for exports |
| `SSH_HOST` | ssh.madfam.io | SSH host for remote ops |
| `GPG_RECIPIENT` | (none) | GPG key for encryption |

## Required Secrets

The following secrets must be present in K8s:

| Key | Description | Generated By |
|-----|-------------|--------------|
| `database-url` | PostgreSQL connection URL | Manual |
| `redis-url` | Redis connection URL | Manual |
| `jwt-secret` | JWT signing key | `openssl rand -base64 32` |
| `secret-key` | Application secret key | `openssl rand -base64 32` |
| `postgres-password` | PostgreSQL password | Manual |
| `internal-api-key` | Internal API key | `openssl rand -hex 32` |

## Secret Rotation

To rotate secrets:

1. Generate new value:
   ```bash
   ./manage-secrets.sh rotate jwt-secret --remote
   ```

2. Restart pods to pick up new secret:
   ```bash
   ssh ssh.madfam.io "sudo kubectl rollout restart deployment/janua-api -n janua"
   ```

3. Monitor rollout:
   ```bash
   ssh ssh.madfam.io "sudo kubectl rollout status deployment/janua-api -n janua"
   ```

## Security Notes

- Never commit secrets to git
- Use GPG encryption for exported secrets
- Rotate secrets regularly (recommended: every 90 days)
- Use separate secrets for dev/staging/production
- Audit secret access via K8s audit logs
