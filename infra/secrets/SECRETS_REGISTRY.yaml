# MADFAM Ecosystem Secrets Registry
# Central source of truth for all secrets across Janua and Enclii projects
# Maintained by: Infrastructure Team
# Review frequency: Weekly (via GitHub Actions)

version: "1.0"
last_audit: "2026-01-16"
maintainers:
  - infrastructure@madfam.io
  - security@madfam.io

# ═══════════════════════════════════════════════════════════════════════════════
# ROTATION POLICIES
# ═══════════════════════════════════════════════════════════════════════════════

rotation_policies:
  quarterly:
    days: 90
    reminder_days: [14, 7, 3, 1]
    description: "High-sensitivity credentials requiring frequent rotation"
    applicable_to: ["database credentials", "service accounts"]

  semi_annual:
    days: 180
    reminder_days: [30, 14, 7, 3, 1]
    description: "Medium-sensitivity credentials"
    applicable_to: ["API keys", "integration tokens"]

  annual:
    days: 365
    reminder_days: [30, 14, 7, 1]
    description: "Lower-sensitivity or operationally complex rotations"
    applicable_to: ["OAuth secrets", "JWT keys", "registry credentials"]

  on_demand:
    days: null
    reminder_days: []
    description: "Rotated only on security events or personnel changes"
    applicable_to: ["encryption keys", "root credentials"]

# ═══════════════════════════════════════════════════════════════════════════════
# JANUA PROJECT SECRETS
# ═══════════════════════════════════════════════════════════════════════════════

secrets:
  janua:
    # ─────────────────────────────────────────────────────────────────────────
    # Database Credentials
    # ─────────────────────────────────────────────────────────────────────────
    - id: janua-postgres-password
      name: POSTGRES_PASSWORD
      description: "Primary PostgreSQL database password for Janua API"
      location: k8s/janua-secrets
      environment: production
      policy: quarterly
      last_rotated: "2025-10-15"
      next_rotation: "2026-01-13"  # OVERDUE
      owner: infrastructure
      procedure: db-password-rotation
      dependencies:
        - janua-api
        - janua-admin
      risk_level: critical
      rotation_downtime: "rolling-restart"
      notes: "Requires coordinated restart of all API pods"

    - id: janua-postgres-readonly-password
      name: POSTGRES_READONLY_PASSWORD
      description: "Read-only PostgreSQL user for analytics and reporting"
      location: k8s/janua-secrets
      environment: production
      policy: quarterly
      last_rotated: "2025-10-15"
      next_rotation: "2026-01-13"  # OVERDUE
      owner: infrastructure
      procedure: db-password-rotation
      dependencies:
        - janua-analytics
        - grafana
      risk_level: high
      rotation_downtime: "none"

    - id: janua-redis-password
      name: REDIS_PASSWORD
      description: "Redis cache authentication password"
      location: k8s/janua-secrets
      environment: production
      policy: quarterly
      last_rotated: "2025-11-01"
      next_rotation: "2026-01-30"
      owner: infrastructure
      procedure: redis-password-rotation
      dependencies:
        - janua-api
        - janua-session-store
      risk_level: high
      rotation_downtime: "rolling-restart"

    # ─────────────────────────────────────────────────────────────────────────
    # Authentication & JWT
    # ─────────────────────────────────────────────────────────────────────────
    - id: janua-jwt-private-key
      name: JWT_PRIVATE_KEY
      description: "RS256 private key for signing JWTs"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-01-15"
      next_rotation: "2026-01-15"  # DUE TOMORROW
      owner: security
      procedure: jwt-key-rotation
      dependencies:
        - janua-api
        - enclii-api  # Cross-project dependency!
      risk_level: critical
      rotation_downtime: "none"
      grace_period_hours: 24
      notes: "Requires 24h grace period for existing tokens. Notify Enclii team."

    - id: janua-jwt-public-key
      name: JWT_PUBLIC_KEY
      description: "RS256 public key for verifying JWTs"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-01-15"
      next_rotation: "2026-01-15"
      owner: security
      procedure: jwt-key-rotation
      dependencies:
        - janua-api
        - enclii-api
      risk_level: high
      rotation_downtime: "none"
      notes: "Rotated together with JWT_PRIVATE_KEY"

    - id: janua-session-secret
      name: SESSION_SECRET
      description: "Express session encryption secret"
      location: k8s/janua-secrets
      environment: production
      policy: semi_annual
      last_rotated: "2025-07-01"
      next_rotation: "2025-12-28"  # OVERDUE
      owner: security
      procedure: session-secret-rotation
      dependencies:
        - janua-api
      risk_level: high
      rotation_downtime: "rolling-restart"
      notes: "All active sessions invalidated on rotation"

    # ─────────────────────────────────────────────────────────────────────────
    # OAuth Provider Secrets
    # ─────────────────────────────────────────────────────────────────────────
    - id: janua-oauth-google-secret
      name: GOOGLE_CLIENT_SECRET
      description: "Google OAuth 2.0 client secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-03-15"
      next_rotation: "2026-03-15"
      owner: security
      procedure: oauth-google-rotation
      dependencies:
        - janua-api
      risk_level: high
      rotation_downtime: "none"
      notes: "Rotate in Google Cloud Console first"

    - id: janua-oauth-github-secret
      name: GITHUB_CLIENT_SECRET
      description: "GitHub OAuth client secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-03-15"
      next_rotation: "2026-03-15"
      owner: security
      procedure: oauth-github-rotation
      dependencies:
        - janua-api
      risk_level: high
      rotation_downtime: "none"
      notes: "Rotate in GitHub Developer Settings first"

    - id: janua-oauth-microsoft-secret
      name: MICROSOFT_CLIENT_SECRET
      description: "Microsoft/Azure AD OAuth client secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-03-15"
      next_rotation: "2026-03-15"
      owner: security
      procedure: oauth-microsoft-rotation
      dependencies:
        - janua-api
      risk_level: high
      rotation_downtime: "none"
      notes: "Rotate in Azure Portal first"

    - id: janua-oauth-apple-secret
      name: APPLE_CLIENT_SECRET
      description: "Apple Sign-In client secret (JWT-based)"
      location: k8s/janua-secrets
      environment: production
      policy: semi_annual
      last_rotated: "2025-06-01"
      next_rotation: "2025-12-01"  # OVERDUE
      owner: security
      procedure: oauth-apple-rotation
      dependencies:
        - janua-api
      risk_level: high
      rotation_downtime: "none"
      notes: "Apple secrets expire after 6 months by design"

    - id: janua-oauth-facebook-secret
      name: FACEBOOK_CLIENT_SECRET
      description: "Facebook/Meta OAuth client secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-03-15"
      next_rotation: "2026-03-15"
      owner: security
      procedure: oauth-facebook-rotation
      dependencies:
        - janua-api
      risk_level: high
      rotation_downtime: "none"

    - id: janua-oauth-twitter-secret
      name: TWITTER_CLIENT_SECRET
      description: "Twitter/X OAuth client secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-03-15"
      next_rotation: "2026-03-15"
      owner: security
      procedure: oauth-twitter-rotation
      dependencies:
        - janua-api
      risk_level: medium
      rotation_downtime: "none"

    - id: janua-oauth-linkedin-secret
      name: LINKEDIN_CLIENT_SECRET
      description: "LinkedIn OAuth client secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-03-15"
      next_rotation: "2026-03-15"
      owner: security
      procedure: oauth-linkedin-rotation
      dependencies:
        - janua-api
      risk_level: medium
      rotation_downtime: "none"

    - id: janua-oauth-discord-secret
      name: DISCORD_CLIENT_SECRET
      description: "Discord OAuth client secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-03-15"
      next_rotation: "2026-03-15"
      owner: security
      procedure: oauth-discord-rotation
      dependencies:
        - janua-api
      risk_level: medium
      rotation_downtime: "none"

    # ─────────────────────────────────────────────────────────────────────────
    # Email Service
    # ─────────────────────────────────────────────────────────────────────────
    - id: janua-smtp-password
      name: SMTP_PASSWORD
      description: "SMTP authentication password for transactional emails"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-05-01"
      next_rotation: "2026-05-01"
      owner: infrastructure
      procedure: smtp-password-rotation
      dependencies:
        - janua-api
        - janua-notification-service
      risk_level: medium
      rotation_downtime: "none"

    - id: janua-sendgrid-api-key
      name: SENDGRID_API_KEY
      description: "SendGrid API key for email delivery"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-05-01"
      next_rotation: "2026-05-01"
      owner: infrastructure
      procedure: sendgrid-key-rotation
      dependencies:
        - janua-api
      risk_level: medium
      rotation_downtime: "none"

    # ─────────────────────────────────────────────────────────────────────────
    # Payment Processing
    # ─────────────────────────────────────────────────────────────────────────
    - id: janua-stripe-secret-key
      name: STRIPE_SECRET_KEY
      description: "Stripe API secret key for payment processing"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-04-01"
      next_rotation: "2026-04-01"
      owner: security
      procedure: stripe-key-rotation
      dependencies:
        - janua-api
        - janua-billing-service
      risk_level: critical
      rotation_downtime: "none"
      notes: "Critical financial system - rotate during low-traffic hours"

    - id: janua-stripe-webhook-secret
      name: STRIPE_WEBHOOK_SECRET
      description: "Stripe webhook signature verification secret"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-04-01"
      next_rotation: "2026-04-01"
      owner: security
      procedure: stripe-webhook-rotation
      dependencies:
        - janua-api
      risk_level: high
      rotation_downtime: "none"
      notes: "Rotate in Stripe Dashboard, then update K8s secret"

    - id: janua-stripe-publishable-key
      name: STRIPE_PUBLISHABLE_KEY
      description: "Stripe publishable key for frontend"
      location: k8s/janua-configmap
      environment: production
      policy: annual
      last_rotated: "2025-04-01"
      next_rotation: "2026-04-01"
      owner: security
      procedure: stripe-key-rotation
      dependencies:
        - janua-dashboard
        - janua-website
      risk_level: low
      rotation_downtime: "redeploy-frontend"

    # ─────────────────────────────────────────────────────────────────────────
    # Infrastructure & CI/CD
    # ─────────────────────────────────────────────────────────────────────────
    - id: janua-ghcr-credentials
      name: ghcr-credentials
      description: "GitHub Container Registry pull credentials"
      location: k8s/imagepullsecret
      environment: production
      policy: annual
      last_rotated: "2026-01-16"  # Just rotated
      next_rotation: "2027-01-16"
      owner: devops
      procedure: ghcr-pat-rotation
      dependencies:
        - all-deployments
      risk_level: high
      rotation_downtime: "none"
      notes: "Uses Fine-grained PAT with read:packages scope"

    - id: janua-cloudflare-api-token
      name: CLOUDFLARE_API_TOKEN
      description: "Cloudflare API token for DNS and CDN management"
      location: k8s/janua-secrets
      environment: production
      policy: annual
      last_rotated: "2025-02-01"
      next_rotation: "2026-02-01"
      owner: infrastructure
      procedure: cloudflare-token-rotation
      dependencies:
        - cert-manager
        - dns-management
      risk_level: high
      rotation_downtime: "none"

    - id: janua-sentry-dsn
      name: SENTRY_DSN
      description: "Sentry error tracking DSN"
      location: k8s/janua-configmap
      environment: production
      policy: on_demand
      last_rotated: "2025-01-01"
      next_rotation: null
      owner: infrastructure
      procedure: manual
      dependencies:
        - all-services
      risk_level: low
      rotation_downtime: "none"
      notes: "Rotate only if DSN is compromised"

    # ─────────────────────────────────────────────────────────────────────────
    # Backup & Storage
    # ─────────────────────────────────────────────────────────────────────────
    - id: janua-s3-access-key
      name: AWS_ACCESS_KEY_ID
      description: "AWS S3 access key for backup storage"
      location: k8s/janua-secrets
      environment: production
      policy: semi_annual
      last_rotated: "2025-08-01"
      next_rotation: "2026-02-01"
      owner: infrastructure
      procedure: aws-key-rotation
      dependencies:
        - backup-cronjob
        - janua-api
      risk_level: high
      rotation_downtime: "none"

    - id: janua-s3-secret-key
      name: AWS_SECRET_ACCESS_KEY
      description: "AWS S3 secret key for backup storage"
      location: k8s/janua-secrets
      environment: production
      policy: semi_annual
      last_rotated: "2025-08-01"
      next_rotation: "2026-02-01"
      owner: infrastructure
      procedure: aws-key-rotation
      dependencies:
        - backup-cronjob
        - janua-api
      risk_level: high
      rotation_downtime: "none"

    - id: janua-backup-encryption-key
      name: BACKUP_ENCRYPTION_KEY
      description: "AES-256 key for backup encryption"
      location: k8s/janua-secrets
      environment: production
      policy: on_demand
      last_rotated: "2025-01-01"
      next_rotation: null
      owner: security
      procedure: backup-key-rotation
      dependencies:
        - backup-cronjob
        - restore-procedures
      risk_level: critical
      rotation_downtime: "none"
      notes: "Keep old key for decrypting historical backups"

  # ═══════════════════════════════════════════════════════════════════════════
  # ENCLII PROJECT SECRETS
  # ═══════════════════════════════════════════════════════════════════════════

  enclii:
    # ─────────────────────────────────────────────────────────────────────────
    # OIDC Integration with Janua
    # ─────────────────────────────────────────────────────────────────────────
    - id: enclii-oidc-client-secret
      name: client-secret
      description: "OIDC client secret for Janua authentication"
      location: k8s/enclii-oidc-credentials
      environment: production
      policy: annual
      last_rotated: "2025-03-01"
      next_rotation: "2026-03-01"
      owner: security
      procedure: oidc-client-rotation
      dependencies:
        - janua-oauth-client  # Cross-project: Janua side must update first
        - enclii-api
      risk_level: high
      rotation_downtime: "none"
      notes: "Coordinate with Janua team - rotate Janua OAuth client first"

    # ─────────────────────────────────────────────────────────────────────────
    # Container Registry
    # ─────────────────────────────────────────────────────────────────────────
    - id: enclii-ghcr-credentials
      name: ghcr-credentials
      description: "GitHub Container Registry pull credentials"
      location: k8s/imagepullsecret
      environment: production
      policy: annual
      last_rotated: "2026-01-16"  # Just rotated
      next_rotation: "2027-01-16"
      owner: devops
      procedure: ghcr-pat-rotation
      dependencies:
        - all-deployments
      risk_level: high
      rotation_downtime: "none"
      notes: "Shares PAT with Janua - coordinate rotation"

    # ─────────────────────────────────────────────────────────────────────────
    # Webhook Security
    # ─────────────────────────────────────────────────────────────────────────
    - id: enclii-webhook-secret
      name: WEBHOOK_SECRET
      description: "Webhook signature verification secret"
      location: k8s/enclii-secrets
      environment: production
      policy: semi_annual
      last_rotated: "2025-09-01"
      next_rotation: "2026-03-01"
      owner: security
      procedure: webhook-secret-rotation
      dependencies:
        - enclii-api
        - janua-webhook-config
      risk_level: medium
      rotation_downtime: "none"
      notes: "Update Janua webhook configuration after rotation"

    # ─────────────────────────────────────────────────────────────────────────
    # Infrastructure
    # ─────────────────────────────────────────────────────────────────────────
    - id: enclii-cloudflare-api-token
      name: CLOUDFLARE_API_TOKEN
      description: "Cloudflare API token for DNS management"
      location: k8s/enclii-secrets
      environment: production
      policy: annual
      last_rotated: "2025-02-01"
      next_rotation: "2026-02-01"
      owner: infrastructure
      procedure: cloudflare-token-rotation
      dependencies:
        - cert-manager
        - dns-management
      risk_level: high
      rotation_downtime: "none"

    # ─────────────────────────────────────────────────────────────────────────
    # Database
    # ─────────────────────────────────────────────────────────────────────────
    - id: enclii-postgres-password
      name: POSTGRES_PASSWORD
      description: "Primary PostgreSQL database password"
      location: k8s/enclii-secrets
      environment: production
      policy: quarterly
      last_rotated: "2025-10-15"
      next_rotation: "2026-01-13"  # OVERDUE
      owner: infrastructure
      procedure: db-password-rotation
      dependencies:
        - enclii-api
      risk_level: critical
      rotation_downtime: "rolling-restart"

    # ─────────────────────────────────────────────────────────────────────────
    # Backup
    # ─────────────────────────────────────────────────────────────────────────
    - id: enclii-backup-encryption-key
      name: BACKUP_ENCRYPTION_KEY
      description: "AES-256 key for backup encryption"
      location: k8s/enclii-secrets
      environment: production
      policy: on_demand
      last_rotated: "2025-01-01"
      next_rotation: null
      owner: security
      procedure: backup-key-rotation
      dependencies:
        - backup-cronjob
      risk_level: critical
      rotation_downtime: "none"
      notes: "Retain old keys for historical backup decryption"

    - id: enclii-restic-password
      name: RESTIC_PASSWORD
      description: "Restic backup repository password"
      location: k8s/enclii-secrets
      environment: production
      policy: on_demand
      last_rotated: "2025-01-01"
      next_rotation: null
      owner: infrastructure
      procedure: restic-password-rotation
      dependencies:
        - backup-cronjob
        - restore-procedures
      risk_level: high
      rotation_downtime: "none"

# ═══════════════════════════════════════════════════════════════════════════════
# CROSS-PROJECT DEPENDENCIES
# ═══════════════════════════════════════════════════════════════════════════════

cross_project_dependencies:
  jwt_keys:
    description: "JWT keys shared between Janua and Enclii for SSO"
    janua_secrets:
      - janua-jwt-private-key
      - janua-jwt-public-key
    enclii_secrets:
      - enclii-oidc-client-secret
    rotation_order:
      1: "Rotate Janua JWT keys with 24h grace period"
      2: "Notify Enclii team of new public key"
      3: "Enclii updates OIDC configuration"
      4: "Verify SSO still works"
      5: "After 24h, remove old JWT keys from Janua"

  ghcr_credentials:
    description: "Shared GitHub PAT for container registry"
    janua_secrets:
      - janua-ghcr-credentials
    enclii_secrets:
      - enclii-ghcr-credentials
    rotation_order:
      1: "Generate new Fine-grained PAT in GitHub"
      2: "Update Janua K8s secret"
      3: "Verify Janua deployments work"
      4: "Update Enclii K8s secret"
      5: "Verify Enclii deployments work"
      6: "Revoke old PAT"

# ═══════════════════════════════════════════════════════════════════════════════
# ROTATION PROCEDURES REFERENCE
# ═══════════════════════════════════════════════════════════════════════════════

procedures:
  db-password-rotation:
    script: scripts/secrets/rotate-db-password.sh
    runbook: docs/runbooks/secrets/db-password-rotation.md
    estimated_duration: "5-10 minutes"
    requires_maintenance_window: false

  jwt-key-rotation:
    script: scripts/secrets/rotate-jwt-keys.sh
    runbook: docs/runbooks/secrets/jwt-key-rotation.md
    estimated_duration: "15-30 minutes"
    requires_maintenance_window: false
    post_rotation_tasks:
      - "Notify Enclii team"
      - "Monitor authentication errors for 24h"
      - "Run cleanup script after grace period"

  ghcr-pat-rotation:
    script: scripts/secrets/rotate-ghcr-credentials.sh
    runbook: docs/runbooks/secrets/ghcr-pat-rotation.md
    estimated_duration: "10-15 minutes"
    requires_maintenance_window: false

  oauth-google-rotation:
    script: null  # Manual process
    runbook: docs/runbooks/secrets/oauth-google-rotation.md
    estimated_duration: "15-20 minutes"
    requires_maintenance_window: false

  oauth-github-rotation:
    script: null
    runbook: docs/runbooks/secrets/oauth-github-rotation.md
    estimated_duration: "10-15 minutes"
    requires_maintenance_window: false

  oauth-microsoft-rotation:
    script: null
    runbook: docs/runbooks/secrets/oauth-microsoft-rotation.md
    estimated_duration: "15-20 minutes"
    requires_maintenance_window: false

  oauth-apple-rotation:
    script: null
    runbook: docs/runbooks/secrets/oauth-apple-rotation.md
    estimated_duration: "20-30 minutes"
    requires_maintenance_window: false

  stripe-key-rotation:
    script: null
    runbook: docs/runbooks/secrets/stripe-rotation.md
    estimated_duration: "15-20 minutes"
    requires_maintenance_window: true
    notes: "Schedule during low-traffic period"

  cloudflare-token-rotation:
    script: scripts/secrets/rotate-cloudflare-token.sh
    runbook: docs/runbooks/secrets/cloudflare-token-rotation.md
    estimated_duration: "5-10 minutes"
    requires_maintenance_window: false

  webhook-secret-rotation:
    script: scripts/secrets/rotate-webhook-secret.sh
    runbook: docs/runbooks/secrets/webhook-secret-rotation.md
    estimated_duration: "5-10 minutes"
    requires_maintenance_window: false

  emergency:
    script: scripts/secrets/emergency-rotate-all.sh
    runbook: docs/runbooks/secrets/EMERGENCY_ROTATION.md
    estimated_duration: "30-60 minutes"
    requires_maintenance_window: true
