# Secrets Rotation Alerts for Non-Operator Prometheus
# Add this as a new key in the prometheus-rules ConfigMap
#
# Note: These alerts require a secrets-exporter to populate the metrics.
# The exporter should expose:
#   - madfam_secret_days_until_rotation{secret_id, project, owner, policy, risk_level}
#   - madfam_secret_rotation_total{secret_id, project, status}
#   - madfam_secret_rotation_failures_total{secret_id, error}

groups:
  - name: secrets.rotation
    interval: 1h
    rules:
      # CRITICAL: Secret rotation is overdue
      - alert: SecretRotationOverdue
        expr: madfam_secret_days_until_rotation < 0
        for: 1h
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Secret rotation is overdue: {{ $labels.secret_id }}"
          description: |
            Secret {{ $labels.secret_id }} in project {{ $labels.project }} is {{ $value | humanize }} days overdue for rotation.
            Owner: {{ $labels.owner }}
            Risk Level: {{ $labels.risk_level }}

            Runbook: https://github.com/madfam/janua/blob/main/docs/runbooks/secrets/EMERGENCY_ROTATION.md

      # CRITICAL: High-risk secret is overdue
      - alert: CriticalSecretOverdue
        expr: |
          madfam_secret_days_until_rotation < 0
          and madfam_secret_risk_level{risk_level="critical"} == 1
        for: 30m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "CRITICAL secret overdue: {{ $labels.secret_id }}"
          description: "A CRITICAL severity secret is overdue for rotation. Immediate action required."

      # WARNING: Secret rotation due within 3 days
      - alert: SecretRotationDue3Days
        expr: |
          madfam_secret_days_until_rotation >= 0
          and madfam_secret_days_until_rotation <= 3
        for: 1h
        labels:
          severity: warning
          team: security
        annotations:
          summary: "Secret rotation due within 3 days: {{ $labels.secret_id }}"
          description: "Secret {{ $labels.secret_id }} needs rotation within {{ $value }} days."

      # WARNING: Secret rotation due within 7 days
      - alert: SecretRotationDue7Days
        expr: |
          madfam_secret_days_until_rotation > 3
          and madfam_secret_days_until_rotation <= 7
        for: 1h
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "Secret rotation due within 7 days: {{ $labels.secret_id }}"
          description: "Plan rotation during the next maintenance window."

      # INFO: Upcoming rotation within 14 days
      - alert: SecretRotationDue14Days
        expr: |
          madfam_secret_days_until_rotation > 7
          and madfam_secret_days_until_rotation <= 14
        for: 1h
        labels:
          severity: info
          team: infrastructure
        annotations:
          summary: "Secret rotation upcoming: {{ $labels.secret_id }}"
          description: "Secret {{ $labels.secret_id }} is due for rotation in {{ $value }} days."

      # CRITICAL: Rotation failed
      - alert: SecretRotationFailed
        expr: increase(madfam_secret_rotation_failures_total[1h]) > 0
        for: 5m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Secret rotation failed: {{ $labels.secret_id }}"
          description: "Automated or manual secret rotation failed. Check rotation logs."

      # CRITICAL: Too many overdue secrets
      - alert: TooManyOverdueSecrets
        expr: count(madfam_secret_days_until_rotation < 0) > 5
        for: 1h
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Multiple secrets are overdue for rotation"
          description: "{{ $value }} secrets are currently overdue. Review SECRETS_REGISTRY.yaml."

  - name: secrets.compliance
    interval: 24h
    rules:
      # CRITICAL: Compliance violation (>30 days overdue)
      - alert: SecretRotationComplianceViolation
        expr: count(madfam_secret_days_until_rotation < -30) > 0
        for: 1h
        labels:
          severity: critical
          team: security
          compliance: "true"
        annotations:
          summary: "Secrets rotation compliance violation"
          description: "{{ $value }} secrets are more than 30 days overdue. This may constitute a compliance violation."
